---
- name: Pulls docker image and writes neccesary .version files
  become: false
  hosts: all
  vars:
    remote_folder: "{{ _remote_folder }}"
    image_tag: "{{ _image_tag }}"
    full_registry_url: "{{ _full_registry_url }}"
    project_name: "{{ _project_name }}"
    project_service: "{{ _project_service }}"
    project_stage: "{{ _project_stage }}"

  tasks:
    - name: Pull image
      community.docker.docker_image_pull:
        name: "{{ full_registry_url }}"
        tag: "{{ image_tag }}"
      tags:
        - docker_pull

    - name: Create .version file
      copy:
        content: |
          # Generated by Ansible on {{ ansible_date_time.iso8601 }}
          # Environment: {{ project_stage }}
          # Build: {{ image_tag }}

          # Service version
          {{ project_name | upper }}_{{ project_service | upper }}_VERSION={{ image_tag }}
          {{ project_name | upper }}_{{ project_service | upper }}_REGISTRY_URL={{ full_registry_url }}
        dest: "{{ remote_folder }}/.version.{{ project_service }}"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0600'

    - name: Create service .env file
      copy:
        content: |
          # Generated by Ansible on {{ ansible_date_time.iso8601 }}
          # Environment: {{ project_stage }}
          # Build: {{ image_tag }}

          # Environment variables from vault
          {{ environment_variables }}
        dest: "{{ remote_folder }}/.env.{{ project_service }}"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0600'
        force: true

